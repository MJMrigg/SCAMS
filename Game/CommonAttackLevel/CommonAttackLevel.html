<html>

<head>
	<script src = "Voicemail_classes.js"></script>
	<script src = "Smish_classes.js"></script>
	<script src = "Call_classes.js"></script>
	<script src = "email.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale:1'">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
	
	<script>
	class main{
		constructor(){
			this.image = '';
			this.questionImg = document.getElementById("pic");
			this.questionImg.src = 'data:image/png;base64,'+ this.image;

			this.gameBank=[];//collection of ALL data

			this.playerAns = [null];//length will change with each type, starts will just 1 to initialize

			this.optTxt = document.getElementById("textOpt");
			this.optCall = document.getElementById("callOpt");
			this.optVoice = document.getElementById("voicemailOpt");
			this.optEmail = document.getElementById("emailOpt");

			this.ansResult = document.getElementById("results");
			this.score = document.getElementById("score");
			this.goButton = document.getElementById("confirm");

			this.gameFinish = false;
			this.maxScore = 0;
			this.correctAnsNum = 0;
			this.currentIndex = 0;
			this.alreadyDone = [];

		}

		changeImage(str){
				//this.image = this.questionBank[this.currIndex].imagebase64;
				this.image = str;
				this.questionImg = document.getElementById("pic");
				this.questionImg.src = 'data:image/png;base64,'+ this.image;
		}

		changeOptType(type){
			//reset array size and clear answers
			for(var i = 0; i<this.playerAns.length;i++){
				this.playerAns.pop();
			}

			//change for smishing
			if(type == 'text'){// smishing: 12, 5 different choices
				this.optEmail.style = "display:none";
				this.optCall.style = "display:none";
				this.optVoice.style = "display:none";
				this.optTxt.style = "display: block";
				
				//2 that must be answered, 3 optional
				this.playerAns.push(null,null,false,false,false);

			}else if(type == 'email'){//phishing: 12, 6 different choices
				this.optCall.style = "display:none";
				this.optTxt.style = "display:none";
				this.optVoice.style = "display:none";
				this.optEmail.style = "display:block";

				//3 that must be answered, 2 optional, 1 must be answered
				this.playerAns.push(null,null,null,false,false,null);

			}else if(type == 'call'){// call vishing: 12, 3 different choices
				this.optTxt.style = "display:none";
				this.optVoice.style = "display:none";
				this.optEmail.style = "display:none";

				this.optCall.style = "display:block";

				//3 that must be answered
				this.playerAns.push(null,null,null);

			}else{// voicemail vishing: 12, 3 different choices
				this.optTxt.style = "display:none";
				this.optEmail.style = "display:none";
				this.optCall.style = "display:none";
				this.optVoice.style = "display:block";

				//3 that must be answered
				this.playerAns.push(null,null,null);
			}

		}

		async getQuestionBank(){
				try {
					//const response = await fetch('SSE_MobileSecurityGame.PhishingBank.json');
					const response = await fetch("/getCommon",{
                        method: "POST",
                        "Content-Type": "application/json",
                    });
					//const data = await response.json();
					var startTime = Date.now(); //Get start and end times to calculate rtt
					const data = await response.json();
					var endTime = Date.now();
					var rtt = endTime - startTime;
					console.log("/getCommon Request RTTs:\nServer-Database Request RTT: "+data.rtt+"ms\nClient-Server Request RTT: "+rtt+"ms\n");

					this.questions = data;

					for(let i = 0; i<this.questions.length-1;i++){
						this.alreadyDone.push(data[i]);
					}
					while(this.questions.length != 0){
						var curr = this.questions.length;
						var currData = this.questions[curr-1];
						if(currData.type == "voice"){
							this.gameBank.push(new Voicemail_Gen(currData.imagebase64, currData.voiceCompany, currData.voicePersonal, currData.voiceUrgent));
						}else if(currData.type == "email"){

							var ans = [currData.senderAdd, currData.emailSubject, currData.emailBody, currData.spellingErrors, currData.soundsOff, currData.pdfIncluded];
							this.gameBank.push(new email(currData.imagebase64, ans));
						}else if(currData.type == "text"){
							var ans = [currData.textNumber, currData.textBody, currData.textLink, currData.textTypo, currData.textClaim]
							this.gameBank.push(new Smish_Class(currData.imagebase64, ans));
						}else{//for calls
							this.gameBank.push(new Call_Gen(currData.imagebase64, currData.callPersonal, currData.callPayment, currData.callYesNo));
						}
						
						this.questions.pop();
					}

					this.currentIndex = Math.floor(Math.random()*this.gameBank.length);
					this.updateScreen();

				} catch (error) {
					console.error("Error fetching question bank:", error);
				}
			}

		checkBoxClick(type, option, checked){
			//checked is bool
			if(type==0){//Smish
				if(option==0){
					this.playerAns[2]=checked;
				}else if(option==1){
					this.playerAns[3]=checked;
				}else{
					this.playerAns[4]=checked;
				}
			}else{//Email
				if(option==0){
					this.playerAns[3]=checked;
				}else{
					this.playerAns[4]=checked;
				}
			}
		}

			changeVal(type, option, selected){
				if(type == 0){//smish
					if(option==0){//phone num
						if(selected==1){
							//they say yes
							this.playerAns[0]=true;
						}else{
							//they say no
							this.playerAns[0]=false;
						}
					}else if(option==1){
						if(selected==1){
							//they say yes
							this.playerAns[1]=true;
							//open up additional options
							document.getElementById("SmishAddOpt").style = "display:block";
							document.getElementById("link").style="display:block";
							document.getElementById("typos").style="display:block";
							document.getElementById("falseClaim").style="display:block";

						}else{
							//they say no
							this.playerAns[1]=false;
							//3 additional answer options from it
							//AND REMEMBER TO CLEAR ADDITIONAL ANSWERS IF ANY WERE CHECKED
							this.playerAns[2]=false;
							this.playerAns[3]=false;
							this.playerAns[4]=false;

							//close additional options if they were there
							document.getElementById("SmishAddOpt").style = "display:none";
							document.getElementById("link").style="display:none";
							document.getElementById("typos").style="display:none";
							document.getElementById("falseClaim").style="display:none";

						}
					}
				}else if(type==1){//Email
					if(option==0){
						if(selected==1){
							//they say yes
							this.playerAns[0]=true;
						}else{
							//they say no
							this.playerAns[0]=false;
						}
					}else if(option==1){
						if(selected==1){
							//they say yes
							this.playerAns[1]=true;
						}else{
							//they say no
							this.playerAns[1]=false;
						}
					}else if(option==2){
						if(selected==1){
							//they say yes
							this.playerAns[2]=true;

							//open up additional options
							document.getElementById("emailAdditional").style = "display:block";
							document.getElementById("feelOff").style="display:block";
							document.getElementById("spellingErr").style="display:block";
						}else{
							//they say no
							this.playerAns[2]=false;

							//close additional options if they were there
							document.getElementById("emailAdditional").style = "display:none";
							document.getElementById("feelOff").style="display:none";
							document.getElementById("spellingErr").style="display:none";
							//AND REMEMBER TO CLEAR ADDITIONAL ANSWERS IF ANY WERE CHECKED
							
							this.playerAns[3]=false;
							this.playerAns[4]=false;
						}
					}else{//for pdf
						if(selected==1){
							//they say yes
							this.playerAns[5]=true;
						}else{
							//they say no
							this.playerAns[5]=false;
						}
					}
				}else if(type==2){//Call
					if(option==0){//asks for personal information
						if(selected==1){
							//they say yes
							this.playerAns[0]=true;
						}else{
							//they say no
							this.playerAns[0]=false;
						}
					}else if(option==1){ //susiciously placed yes and no questions
						if(selected==1){
							//they say yes
							this.playerAns[1]=true;
						}else{
							//they say no
							this.playerAns[1]=false;
						}
					}else{//odd payment method or just ask for one
						if(selected==1){
							//they say yes
							this.playerAns[2]=true;
						}else{
							//they say no
							this.playerAns[2]=false;
						}
					}
				}else{//Voicemail
					if(option==0){//claims to be a specific/known company
						if(selected==1){
							//they say yes
							this.playerAns[0]=true;
						}else{
							//they say no
							this.playerAns[0]=false;
						}
					}else if(option==1){//asks for personal information
						if(selected==1){
							//they say yes
							this.playerAns[1]=true;
						}else{
							//they say no
							this.playerAns[1]=false;
						}
					}else{//makes it sound like its an urgent matter
						if(selected==1){
							//they say yes
							this.playerAns[2]=true;
						}else{
							//they say no
							this.playerAns[2]=false;

						}
					}
				}
			}

			submitAnswers(){
				//console.log("Pressed");
				//console.log("Yes and No value: " + this.playerAns);
				console.log(this.correctAnsNum);
				var allAns = true;
				for(var i = 0; i<this.playerAns.length-1;i++){
					if(this.playerAns[i]==null){
						allAns = false;
					}
				}
				if(!allAns){
					this.ansResult.innerText = "Please answer all questions before submitting!";
				}else{
					var check = this.checkAllAns();//check answers to display proper result message
					//var nextIndex = this.mailCurrentIndex + 1;//makes next index a temporary variable
					//console.log("next index: "+nextIndex);
					if(check){
						this.ansResult.innerText = "Fantastic!";
					}else{
						this.ansResult.innerText = "Not Quite!";
					}
					var doneCount = 0;
					for(let i =0; i<this.gameBank.length;i++){
						if(this.alreadyDone[i]){
							doneCount++;
						}
					}
					if(this.checkDone){
						for(let i = 0;i<this.gameBank.length;i++){
							this.alreadyDone[i]=false;
							//resets game
							this.currentIndex=Math.floor(Math.random()*this.gameBank.length);
						}
					}else{
						this.score.innerText = "Your score: " + this.correctAnsNum + "/" + this.maxScore;
						this.goButton.innerText = "Next level";
						this.goButton.onclick = () => this.nextQuestion();
					}
					this.goButton.innerText = "Next level";
					this.goButton.onclick = () => this.nextQuestion();
				}
			}

			checkDone(){
				for(var i = 0;i<this.alreadyDone.length-1;i++){
					if(!this.alreadyDone.length[i]){
						return false;
					}
				}
				return true;
			}


			nextQuestion(){
				//var len = this.questionBank.length;
				//while(this.alreadyDone[this.currIndex]){
				this.alreadyDone[this.currentIndex] = true;

				while(this.alreadyDone[this.currentIndex]){
					this.currentIndex = Math.floor(Math.random()*this.gameBank.length);
				}
				for(var i = 0;i<6;i++){
					//clears player's current answer array
					this.playerAns[i] = null;
				}
				

				this.playerAns[3] = false;
				this.playerAns[4] = false;

				//emails
				document.getElementById("emailAd").style.color = "black";
				document.getElementById("subjectLine").style.color = "black";
				document.getElementById("emailBod").style.color = "black";
				document.getElementById("feelOff").style.color = "black";
				document.getElementById("spellingErr").style.color = "black";
				document.getElementById("pdf").style.color.color = "black";

				//texts
				document.getElementById("SmishAddOpt").style.color = "black";
				document.getElementById("link").style.color="black";
				document.getElementById("typos").style.color="black";
				document.getElementById("falseClaim").style.color="black";

				//voicemails

				//calls

				var rad = document.querySelectorAll('input[type="radio"]');
				for(var i = 0;i<rad.length;i++){
					rad[i].checked = false;
				}

				document.getElementById("emailAdditional").style = "display:none";

				document.getElementById("feelOff").style="display:none";
				document.getElementById("spellingErr").style="display:none";

				document.getElementById("feelOff").checked = false;
				document.getElementById("spellingErr").checked = false;
	
				document.getElementById("pdf").checked = false;

				this.score.innerText = "Your score: " + this.correctAnsNum + "/" + this.maxScore;

				this.updateScreen();
			}

			checkAllAns(){
				console.log(this.playerAns);
				console.log(this.gameBank[this.currIndex].corAns);
				var allCor = false;
				var levelCor = 0;
				for(var i = 0; i<this.playerAns.length;i++){
					if(this.gameBank[this.currIndex].checkCorrect(i, this.playerAns[i])){
						this.correctAnsNum++;
						levelCor++;
						if(i==0){
							document.getElementById("emailAd").style.color = "green";

						}else if(i==1){
							document.getElementById("subjectLine").style.color = "green";
						}else if(i==2){
							document.getElementById("emailBod").style.color = "green";
						}else if(i==3){
							document.getElementById("spellingErr").style.color = "green";
						}else if(i==4){
							document.getElementById("feelOff").style.color = "green";
						}else{
							document.getElementById("pdf").style.color = "green";
						}
						
					}else{
						if(i==0){
							document.getElementById("emailAd").style.color = "red";

						}else if(i==1){
							document.getElementById("subjectLine").style.color = "red";
						}else if(i==2){
							document.getElementById("emailBod").style.color = "red";
						}else if(i==3){
							document.getElementById("spellingErr").style.color = "red";
						}else if(i==4){
							document.getElementById("feelOff").style.color = "red";
						}else{
							document.getElementById("pdf").style.color = "red";
						}
					}
				}
			}

			updateScreen(){
				//this.changeImage();
				
				this.changeImage(this.gameBank[this.currentIndex].imgUrl);
				this.changeOptType(this.gameBank[this.currentIndex].type);
				/*for(var i = 0; i<this.playerAns.length;i++){
					this.playerAns[i]=null;
				}*/
				for(var i = 0; i<this.playerAns.length;i++){
					this.playerAns[i]=null;
				}
				this.playerAns[3]=false;
				this.playerAns[4]=false;

				this.goButton.innerText = "Submit Answers";
				this.goButton.onclick = () => this.submitAnswers();
				this.ansResult.innerText = " ";
				//this.score.innerText = "Your score: " + this.correctAnsNum + "/" + this.maxScore;

			}
	}
	</script>
</head>
	
<body>
	<link rel="stylesheet" href="../../styles.css">

	<div class = "menu" style="height: auto; width:700px;">
		<!--for testing purposes!-->
			<button onclick="m.changeOptType('text')">Text</button>
			<button onclick="m.changeOptType('email')">Email</button>
			<button onclick="m.changeOptType('call')">Call</button>
			<button onclick="m.changeOptType('voice')">Voicemail</button>
		<!--End for testing purposes-->

		<img id="pic" src = "" alt = "Loading image! Please wait." width = "650" height="420" /><br>

		<div id = "textOpt" style = "display:none">
			<div id="SmishphoneNum" for="SmishphoneNum" style="border: 1px solid #000">
				<center><b>Weird Phone Number</b><br>
				<input type="radio" id="SmishnumT" name="Smishnum" onclick="m.changeVal(0,0,1)">
				<label for = "OptionSel1">Yes</label>
				<input type="radio" id="SmishnumF" name="Smishnum" onclick="m.changeVal(0,0,0)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>
			<div id="Smishbody" for="Smishbody" style="border: 1px solid #000">
				<center><b>Weird Message Body</b><br>
				<input type="radio" id="SmishbodyT" name="Smishbody" onclick="m.changeVal(0,1,1)">
				<label for = "OptionSel1">Yes</label>
				
				<input type="radio" id="SmishbodyF" name="Smishbody" onclick="m.changeVal(0,1,0)">
				<label for = "OptionSel1">No</label>

				<div id="SmishAddOpt" name ="SmishAddOpt" onclick="m.changeVal" style="display:none">
					<input type = "checkbox" name="link" onclick="m.checkBoxClick(0,0,this.checked)">Link</input>
					<input type="checkbox" name = "typos" onclick="m.checkBoxClick(0,1,this.checked)">Typos</input>
					<input type="checkbox" name="falseClaim" onclick="m.checkBoxClick(0,2,this.checked)">False Claim</input>
				</div>
				</center>
			</div>
		</div>

		<div id = "emailOpt" style="display:none">
			<div id = "emailAd" for = "emailAd" style = "border: 1px solid #000;">
				<center><b>Weird Email Address</b><br>
				<input type = "radio" id = "emailAdT" name = "emailAdd" onClick = "m.changeVal(1,1,1)">
				<label for = "OptionSel1">Yes</label>
				<input type = "radio" id = "emailAdF" name ="emailAdd" onClick = "m.changeVal(1,0,0)">
				<label for = "OptionSel1">No</label>
			</div>
		
			<div id = "subjectLine" for = "subjectLine" style = "border: 1px solid #000;">
				<center><b>Weird Email Subject Line</b><br>
				<input type = "radio" id = "subT" name = "subject" onClick = "m.changeVal(1,1,1)">
				<label for = "OptionSel1">Yes</label>
				<input type = "radio" id = "subF" name = "subject" onClick = "m.changeVal(1,1,0)">
				<label for = "OptionSel1">No</label>
			</div>
		
			<div id = "emailBod" for = "emailBod" style = "border: 1px solid #000;">
				<center><b>Weird Email Body</b><br>
				<input type = "radio" id = "bodT" name = "emailBod"onClick = "m.changeVal(1,2,1)">
				<label for = "OptionSel1">Yes</label>
				<input type = "radio" id = "bodF" name = "emailBod"onClick = "m.changeVal(1,2,0)">
				<label for = "OptionSel1">No</label>
				
				<div id="emailAdditional" style="display:none">
					<input type = "checkbox" value = "spellingErr" id = "spellingErr"onclick="m.changeCheck(1, 0,this.checked)">Spelling mistakes</input>
					<input type = "checkbox"value="feelOff" id="feelOff"onclick="m.changeCheck(1, 1,this.checked)">Sounds off</input>
				</div>
				
				</center>
			</div>
			<div id = "pdf" for = "pdf"style = "border: 1px solid #000;">
				<center><b>PDF Included</b><br>
				<input type = "radio" id = "pdfIn" name = "yesNo"onClick = "m.changeVal(1,5,1)">
				<label for = "OptionSel1">Yes</label>
				<input type = "radio" id = "pdfIn" name = "yesNo"onClick = "m.changeVal(1,5,0)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>
		</div>

		<div id = "callOpt" style="display:none">
			<div id="personalInfoCall name = "personalInfoCall" style="border: 1px solid #000;">
				<center><b>Asks for Personal Information</b><br>
				<input type="radio" id="persCallT" name="numCall" onclick="m.changeVal(2,0,0)">
				<label for = "OptionSel1">Yes</label>
				<input type="radio" id="persCallF" name="numCall" onclick="m.changeVal(2,0,1)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>
			<div id="susYesNo" name = "susYesNo" style="border: 1px solid #000;">
				<center><b>Suspicious Yes and No Questions</b><br>
				<input type="radio" id="susYesNoT" name="susYesNo" onclick="m.changeVal(2,1,0)">
				<label for = "OptionSel1">Yes</label>
				<input type="radio" id="susYesNoF" name="susYesNo" onclick="m.changeVal(2,1,1)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>
			<div id="payMethodCall" name = "payMethodCall" style="border: 1px solid #000;">
				<center><b>Asks for an Odd Payment Method</b><br>
				<input type="radio" id="payMethodCallT" name="payMethodCall" onclick="m.changeVal(2,2,0)">
				<label for = "OptionSel1">Yes</label>
				<input type="radio" id="payMethodCallF" name="payMethodCall" onclick="m.changeVal(2,2,1)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>
		</div>

		<div id = "voicemailOpt" style="display:none">
			<div id = "companyClaim" style = "border: 1px solid #000;">
				<center><b>Suspicious claim to be a company</b><br>
					<input type = "radio" id = "OptionSel1" name = "company" onClick = "m.changeVal(3,0,1)">
					<label for = "OptionSel1">Yes</label>
					<input type = "radio" id = "OptionSel1" name ="company" onClick = "m.changeVal(3,0,0)">
					<label for = "OptionSel1">No</label>
				</center>
			</div>
			<div id = "personalInfoCall" style = "border: 1px solid #000;">
				<center><b>Asks for personal information</b><br>
				<input type = "radio" id = "OptionSel1" name = "personalInfoCall" onClick = "m.changeVal(3,1,1)">
				<label for = "OptionSel1">Yes</label>
				<input type = "radio" id = "OptionSel1" name = "personalInfoCall" onClick = "m.changeVal(3,1,0)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>
			<div id = "urgentClaim" style = "border: 1px solid #000;">
				<center><b>Details it as an urgent matter</b><br>
				<input type = "radio" id = "OptionSel1" name = "urgent"onClick = "m.changeVal(2,1)">
				<label for = "OptionSel1">Yes</label>
				<input type = "radio" id = "OptionSel1" name = "urgent"onClick = "m.changeVal(2,0)">
				<label for = "OptionSel1">No</label>
				</center>
			</div>

		</div>

		<button id="confirm" class="selection" onclick = "m.submitAnswers()">Confirm Selection</button>
		<div id = "results" style = "height:auto;"><br></div>
		<div id="score" style="height: auto;"><br></div>
		<div id = "finishedDisplay" style = "font-size:25px;text-align:center"></div>
		<button id="returnLevel" class = "selection" onclick = "window.location.href = '../menu.html'">Return to Level screen</button><br>

	</div>


	<script>
		var m = new main();
	</script>
</body>
</html>
