<!DOCTYPE html>
<html lang="en">
  <meta name="viewport" content="width=device-width, initial-scale:1.0'">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
  <head>
    <meta charset="UTF-8">
    <title>Firewall Ninja</title>
    <script>
        class main{
            constructor(){
                this.score = 0; //The player's starts at score is 0
                this.lives = 10; //The player starts with 10 lives
                this.packets = []; //Stores where the packets appear on the screen
                this.gameStarted = false; //The Game has not yet started
                this.gameOver = false; //The Game has not yet ended
                this.tutorial = true; //Do not start the tutorial
                this.tutorialPart = 0; //Start at the beginning of the tutorial
                this.wait = false; //Don't wait before drawing the next frame
                this.speedModifier = 0; //Modifier of the speed (increases over time)
                this.frame = 0; //Frame of the game
                //Get the canvas width based on the screen size
                var rect = canvas.getBoundingClientRect();
                this.canvasWidth = Math.min(rect.width, rect.right-Math.max(0,rect.left))
                this.drawStartScreen(); //Draw the first frame
            }
            
            //Take in the amount of points the score should change by, change the score, and update the score on the scren
            updateScore(change) {
                this.score += change;
                document.getElementById("score").textContent = "Score: " + this.score + " | Lives: " + this.lives;
            }
            
            //Create a packet and add it to the packets array
            spawnPacket(highType, lowType) {
                //Calculate the minimum and maximum X values for spawning packets based on the canvas position
                var MaxX = this.canvasWidth - 100;
                var MinX = 0;
                var left = canvas.getBoundingClientRect().left;
                if(left < 0){
                    MinX = Math.abs(left)+60;
                }
                //If there is no min or max type, set them to default values to allow every kind of packet to spawn
                var minType = lowType;
                var maxType = highType;
                if(minType === undefined || maxType === undefined){
                    minType = 0;
                    maxType = 5;
                }
                //Create the packet
                const packet = {
                    type: Math.floor(Math.random() * (maxType - minType) + minType),
                    x: Math.random() * (MaxX-MinX+1) + MinX,
                    y: -30,
                    width: 60,
                    height: 60,
                    speed: (1.2 + Math.random() * 0.5) + this.speedModifier,
                    text: "",
                    textX: -60,
                    textY: 28,
                    PIC: new Image(),
                    src: ""
                };
                //Based on the packet's color, set its text, text location, and picture
                switch(packet.type){
                    case 0:
                        break; //Benign packets don't have text
                    case 1:
                        packet.text = "Malware";
                        packet.textX = 10;
                        packet.PIC.src = "Malware.png";
                        packet.src = "Malware.png";
                        break;
                    case 2:
                        packet.text = "Smishing";
                        packet.textX = 7.5;
                        packet.PIC.src = "Smishing.png";
                        packet.src = "Smishing.png";
                        break;
                    case 3:
                        packet.text = "Spam Email";
                        packet.textX = 3;
                        packet.PIC.src = "Spam.png";
                        packet.src = "Spam.png";
                        break;
                    case 4:
                        packet.text = "Vishing";
                        packet.textX = 12;
                        packet.PIC.src = "Vishing.png";
                        packet.src = "Vishing.png";
                        break;
                }
                //Add picture to the packet
                packet.PIC.onload = () => {
                    ctx.drawImage(packet.PIC, packet.x+6, packet.y, 48, 48);
                };
                this.packets.push(packet);
            }
            
            //Take in a packet and draw it
            drawPacket(packet) {
                //Figure out the packet color and text size based on the type
                ctx.font = "11px Arial";
                if(packet.type == 0){ //Benign packet
                    ctx.fillStyle = "green";
                }else{ //Malicious packet
                    ctx.fillStyle = "white";
                    if(packet.type == 3){ //Spam packet has smaller text
                        ctx.font = "10px Arial";
                    }
                }
                //Add packet
                ctx.fillRect(packet.x, packet.y, packet.width, packet.height);
                //Add packet image if it's a malicious packet
                if(packet.type > 0){
                    ctx.drawImage(packet.PIC, packet.x+6, packet.y, 48, 48);
                }
                //Add packet text
                ctx.fillStyle = "black";
                ctx.fillText(packet.text, packet.x+packet.textX, packet.textY);
            }
            
            //Draw the start screen on the canvas
            drawStartScreen() {
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "white";
                var rect = canvas.getBoundingClientRect();
                var centerX = rect.width;
                //Adjustments to center the text
                var Adjust1 = 100;
                if(this.tutorial){
                    Adjust1 = 65;
                }
                var Adjust2 = 70;
                var bigFont = "36px Arial";
                var smallFont = "24px Arial";
                //Adjust the font sizes and positions for smaller screens
                if(window.innerWidth < 600){
                    Adjust1 = 80;
                    if(this.tutorial){
                        Adjust1 = 45;
                    }
                    Adjust2 = 40;
                    bigFont = "26px Arial";
                    smallFont = "14px Arial";
                }
                //Draw start text
                ctx.font = bigFont;
                if(this.tutorial){ //If this is the tutorial
                    ctx.fillText("Tutorial", centerX / 2 - Adjust1, canvas.height / 2 - 30);
                }else{
                    ctx.fillText("Firewall Ninja", centerX / 2 - Adjust1, canvas.height / 2 - 30);
                }
                ctx.font = smallFont;;
                ctx.fillText("Click to Start", centerX / 2 - Adjust2, canvas.height / 2 + 20);
            }

            //Draw the game over screen on the canvas
            drawGameOver() {
                //Delete all the packets
                for(var i = this.packets.length - 1; i >= 0; i--){
                    this.packets.splice(i, 1);
                }
                //Data for game over screen
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "white";
                var rect = canvas.getBoundingClientRect();
                var centerX = rect.width;
                var Adjust1 = 100;
                var Adjust2 = 80;
                var Adjust3 = 90;
                var bigFont = "36px Arial";
                var smallFont = "24px Arial";
                //Adjust the font sizes and positions for smaller screens
                if(window.innerWidth < 600){
                    Adjust1 = 60;
                    Adjust2 = 40;
                    Adjust3 = 43;
                    bigFont = "26px Arial";
                    smallFont = "14px Arial";
                }
                //Draw game over text
                ctx.font = bigFont;
                ctx.fillText("Game Over", centerX / 2 - Adjust1, canvas.height / 2 - 40);
                ctx.font = smallFont;
                ctx.fillText("Final Score: " + this.score, centerX / 2 - Adjust2, canvas.height / 2);
                ctx.fillText("Click to Restart", centerX / 2 - Adjust3, canvas.height / 2 + 40);

                if(this.tutorial){ //If this was the tutorial, tell the player what happens when they lose
                    this.handleTutorial();
                }else{ //Else, add the result to their total score and mark the tutorial as complete
                    var playerCurrentScore = JSON.parse(sessionStorage.getItem("currentScore"));
                    playerCurrentScore += Math.max(0,this.score);
                    //playerCurrentScore += score;
                    sessionStorage.setItem("currentScore",JSON.stringify(playerCurrentScore));
                }
            }
            
            //Restart the game
            resetGame() {
                this.score = 0;
                this.lives = 10;
                //Delete all packets in the game
                this.packets.forEach((packet, index) => {
                    this.packets.splice(index, 1);
                });
                this.gameStarted = true;
                this.gameOver = false;
                if(this.tutorial) this.tutorialPart = 0;
                this.updateScore(0);
                this.gameLoop();
            }
            
            //Draw the current frame
            gameLoop() {
                //Draw the start screen if the game has yet to start
                if (!this.gameStarted) {
                    this.drawStartScreen();
                    return;
                }

                //Stop drawing frames if the game is over
                if (this.lives <= 0) {
                    this.gameOver = true;
                    this.drawGameOver();
                    return;
                }

                //Increase the frame number
                this.frame += 1;
                //Increase the speed modifer after a certain amount of grames
                if(this.frame % 60 == 0){
                    this.speedModifier += 0.05;
                    console.log(this.speedModifier);
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height); //Clear the canvas
                //Draw each packet at their new position
                this.packets.forEach((packet, index) => {
                    packet.y += packet.speed;
                    packet.textY += packet.speed; //Move the text down with the packet
                    this.drawPacket(packet);

                    //If that new position is below the canvas, take away a point and delete the packet
                    if (packet.y > canvas.height) {
                        //Take away a life if the packet was not a benign packet
                        if(packet.type > 0){
                            this.lives--;
                        }
                        //Give the player points for letting a benign packet through, take away points for letting a bad packet through
                        this.updateScore(packet.type == 0 ? 1 : -1);
                        //Delete the packet(because JavaScript is memory safe, removing it from the array will do this)
                        this.packets.splice(index, 1);
                        if(this.tutorial) this.handleTutorial(); //If this was the tutorial, handle what happens when the player lets a packet through
                    }
                });

                if(this.tutorial){ //If this is the tutorial, handle the tutorial functionality
                    this.handleTutorial();
                }else{ //If it's not, proceed as normal
                    if (Math.random() < (0.05 + this.spawnModifier)) this.spawnPacket(); //Possibly spawn a new packet
                }
            }

            //Do the tutorial based on which part of the tutorial the player is on
            handleTutorial(){
                switch(this.tutorialPart){
                    case 0:
                        alert("Welcome to the Firewall Ninja Tutorial! In this game, you play as the firewall and have to filter out messages from your user's mobile device.");
                        //Spawn a good message
                        this.spawnPacket(0,0);
                        this.packets[this.packets.length-1].x = this.canvasWidth / 2;
                        this.tutorialPart += 1;
                        break;
                    case 1:
                        //If the packet has reached the center of the screen, slow the message so that the player can propertly see it
                        if(this.packets[this.packets.length-1].y < canvas.height / 88){
                            return;
                        }
                        var originalSpeed = this.packets[this.packets.length-1].speed; //Keep track of the original packet's speed
                        this.packets[this.packets.length-1].speed = 0.15;
                        alert("This is a good message. Do not filter these. Let them fall off the screen and into the user's device.");
                        this.packets[this.packets.length-1].speed = originalSpeed; //Restore the original speed
                        this.tutorialPart += 1;
                        break;
                    case 2:
                        if(this.packets.length > 0){
                            return; //Wait until the first benign packet is gone
                        }
                        alert("When a good messages reaches the user's mobile device, your score will increase by 1. If you filter a good message, your score will decrease by 1.");
                        this.tutorialPart += 1;
                        break;
                    case 3:
                        alert("Let's look at at some malevolent messages.");
                        this.tutorialPart += 1;
                        break;
                    case 4:
                        //Spawn one if each malevolent type
                        for(var i = 1; i <= 4; i++){
                            this.spawnPacket(i,i+1);
                            this.packets[this.packets.length-1].x = (2+i)*(this.canvasWidth / 8);
                        }
                        this.tutorialPart += 0.5;
                        break;
                    case 4.5:
                        //Wait until the packets have gotten to a point on the screen where the player can see them
                        if(this.packets[this.packets.length-1].y < canvas.height / 88){
                            return;
                        }
                        alert("These are bad messages. Click on them to filter them before they reach the user's mobile device.");
                        this.tutorialPart += 0.5;
                        //Make all the packets slow so the player can click them
                        for(var i = 0; i < this.packets.length; i++){
                            this.packets[i].speed = 0.15;
                        }
                        break;
                    case 5:
                        if(this.packets.length > 0){
                            return; //Wait until the player has clicked all of the packets
                        }
                        alert("When you click on a bad message, your score will increase by 1.");
                        //Spawn a malevolet packet that is too fast for the player to click
                        this.spawnPacket(1,5);
                        this.packets[this.packets.length-1].speed = 30.0; //Make it really fast
                        this.packets[this.packets.length-1].x = this.canvasWidth / 2;
                        this.tutorialPart += 1;
                        break;
                    case 6:
                        if(this.packets.length > 0){
                            return; //Wait until the packet is gone
                        }
                        alert("Oh no! A bad message got through to the user's mobile device! When that happens, you will lose a life. When you lose all 10 lives, the user's phone is so full of malware, its basically unusable.");
                        this.tutorialPart += 1;
                        break;
                    case 7:
                        //Spawn 10 really fast packets so that the user can't click them
                        for(let i = 0; i < 10; i++){
                            this.spawnPacket(1,5);
                            this.packets[this.packets.length-1].speed = 30.0; //Make it really fast
                        }
                        this.tutorialPart += 1;
                        break;
                    case 8:
                        if(this.gameOver){
                            alert("Oh no! Too many bad messages have gotten through! When this happens, the game is over and you will have a chance to play again. Enjoy!");
                            this.tutorialPart += 1;
                        }
                        break;
                }
            }

            //Handle when the player clicks on the screen
            handleClick(e){
                //If the game has yet to start, start the game
                if (!this.gameStarted) {
                    this.gameStarted = true;
                    this.updateScore(0);
                    this.gameLoop();
                    return;
                }

                //If the game just finished, restart the game
                if (this.gameOver) {
                    this.resetGame();
                    return;
                }

                //If the game is in full swing, check to see if the player clicked on a packet
                const rect = canvas.getBoundingClientRect();
                var clickX = e.clientX - rect.left;
                //Adjust the clickX if the canvas has been compressed for smaller screens
                if(rect.left < 0){
                    clickX = e.clientX + Math.abs(rect.left);
                }
                var clickY = e.clientY - rect.top;
                //If the click coordinates are invalid, do nothing
                if(isNaN(clickX) || isNaN(clickY)){
                    return;
                }

                //For each packet, get its information and see if the player clicked it
                for (let i = 0; i < this.packets.length; i++) {
                    const p = this.packets[i];
                    //If the player didn't click on the packet, keep going through packets
                    if(clickX < p.x || clickX > p.x + p.width || clickY < p.y || clickY > p.y + p.height){
                        continue;
                    }
                    //If they did, update the score and remove it
                    this.updateScore(p.type == 0 ? -1 : 1);
                    //If they clicked a benign packet, lose a life
                    if(p.type == 0){

                    }
                    this.packets.splice(i, 1);
                    if(this.tutorial){ //If this was the tutorial, handle what happens when the player clicks a packet
                        if(!Number.isInteger(this.tutorialPart)) this.tutorialPart += 0.5;
                        this.handleTutorial();
                    }
                    break; //Stop checking, since the player can only remove one packet per click
                }
            }

            //Get the score currently in session storage, add the game score, store the result, and leave the game
            saveAndQuit(){
                var playerCurrentScore = JSON.parse(sessionStorage.getItem("currentScore"));
                playerCurrentScore += Math.max(0,this.score);
                sessionStorage.setItem("currentScore", JSON.stringify(playerCurrentScore));
                window.location.href = '../menu.html';
            }
            
            //Restart the tutorial
            restartTutorial(){
                this.tutorial = true;
                this.tutorialPart = 0; //Restart the tutorial
                //Set the score to 0, lives to 10, and get rid of all packets
                this.score = 0;
                this.updateScore(0);
                this.lives = 10;
                this.packets.forEach((packet, index) => {
                    this.packets.splice(index, 1);
                });
                //Begin the game
                this.gameStarted = false;
                this.gameOver = false;
                this.drawStartScreen();
            }

            //Skip the tutorial by setting up the game so that it doesn't do the tutorial
            skipTutorial(){
                if(!this.tutorial){ //Don't do this if this isn't the tutorial
                    return;
                }
                this.tutorial = false; //This is not the tutorial
                //Set the score to 0, lives to 10, and get rid of all packets
                this.score = 0;
                this.updateScore(0);
                this.lives = 10;
                this.packets.forEach((packet, index) => {
                    this.packets.splice(index, 1);
                });
                //Begin the game
                this.gameStarted = false;
                this.gameOver = false;
                this.drawStartScreen();
            }

            static click(e){
                mymain.handleClick(e);
            }
            static loop(){
                mymain.gameLoop();
                requestAnimationFrame(main.loop);
            }
        }
    </script>
    <link rel="stylesheet" href="../../styles.css">
  </head>
  <body>
    <div class="menuForBadPackets">
        <div class="flexForBadPackets" style="display: flex; align-items: center;">
            <div class="forBadPackets">
                <div id="score" class="badPacketsScore">Score: 0 | Lives: 10</div>
                <canvas id="gameCanvas" class="forBadPackets" width="800" height="600"></canvas>
                <script>
                    const canvas = document.getElementById("gameCanvas");
                    const ctx = canvas.getContext("2d");
                    const mymain = new main;

                    canvas.addEventListener("click", main.click);
                    canvas.addEventListener("touchstart", main.click); //For mobile devices
                    requestAnimationFrame(main.loop);
                </script>
            </div>
            <div style="margin-left: 8px;">
                <div style="display: flex; align-items: left; flex-direction: column;">
                    <button class="badPackets" onclick=mymain.saveAndQuit()>Save and Quit</button>
                    <button class="badPackets" onclick="mymain.skipTutorial()">Skip Tutorial</button>
                    <button class="badPackets" onclick="mymain.restartTutorial()">Restart Tutorial</button>
                </div>
            </div>
        </div>
        <p style="color: black; text-align: center;">Free clip art is taken from iconshock.com</p>
    </div>
  </body>
</html>
