<!DOCTYPE html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale:1.0'">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
<head>
  <meta charset="UTF-8" />
  <title>SCAMS Permissions Level</title>
  <link rel="stylesheet" href="../../styles.css">
  <script>
    class main{
      constructor(){
        // Get the apps to display based on the stage
        this.stage = JSON.parse(sessionStorage.getItem("permissionsLevelStage"));
        this.currentStage = this.stage;
        this.allApps = []; //All of the apps(questions)
        //Keep track of the player's responses
        this.responses = JSON.parse(sessionStorage.getItem("permissionsLevelResponses"));
        if(this.responses == undefined || this.responses == "undefined" || this.responses == null || this.responses == "null"){
          this.responses = {};
        }
        this.getAllQuestions(); //Get all the questions from the server
      }
      // Have the player read the tutorial text using the alert function
      doTutorial(){
        alert("Welcome to the App Permissions Level! In this level, you will be giving apps permission to access certain parts of your phone like your contacts, photos, and microphone.");
        alert("Each app will be displayed using a picture and its name. Below it will be check boxes with options next to them. Each option is a part of your phone and checking the box next to it gives the app permission to access that part of the phone.");
        alert("This is the tutorial level, so it should be an easy one. This first app is an app that takes all data is has permission to access and sends it to a shady third party. You must decide which parts of your phone, if any, the app should have access to.");
        alert("Once you're done, click the \"Confirm Settings\" button to confirm that the app will have access to this part of your phone. After that, the correct answers will be revealed and you will see what you got right and wrong.");
      }
      // Creates the container that the different app sections reside in
      createAppUI() {
        // Add title and description to screen
        const titleContainer = document.getElementById("title");
        const title = document.createElement("div");
        title.className = "app-container";
        title.innerHTML = `<h1>Settings/General/App Permissions</h1>
      <h5>Whenever you open a new app on your phone, you have probably been given an alert box that asks you for 
    permissions on your location, camera, etc. Giving these permissions tends to be easy by pressing 1 button, 
    but have you ever thought about what the app was and how it relates to the permissions that you are giving them? 
    For this level, you are tasked to give only the correct permissions to the apps that are displayed.</h5>
    <h2>How to Play:</h2>
    <h5>Below are a list of apps identified by their name and picture. Below each app is a list of checkboxes.
      Each checkbox is a part of your phone you are giving the app permission to access. You must give each app the correct permissions
      and only the correct permissions.</h5>
      <h5>Note: You are giving the app the minimum permissions it needs to function, not the most convenient permissions.</h5>`;
        titleContainer.appendChild(title);
        // Add apps to screen
        const appsContainer = document.getElementById("apps");
        for(var i = 0; i < this.selectedApps.length; i++){ //For each selected app
          const div = document.createElement("div"); // div to contain app
          div.className = "app-container";
          div.innerHTML = `<img src="${this.selectedApps[i].image}" width="70" height="70"></img>
          <h1 style='display:inline;'>${this.selectedApps[i].name}</h1>
            ${this.checkbox("camera", this.selectedApps[i].correctPermissions.camera, i)}
            ${this.checkbox("location", this.selectedApps[i].correctPermissions.location, i)}
            ${this.checkbox("microphone", this.selectedApps[i].correctPermissions.microphone, i)}
            ${this.checkbox("photos", this.selectedApps[i].correctPermissions.photos, i)}
            ${this.checkbox("contacts", this.selectedApps[i].correctPermissions.contacts, i)}
          <p>Credits to <a href=${this.selectedApps[i].link}>${this.selectedApps[i].creator}</a> for this image.</p>`;
          appsContainer.appendChild(div);
        }
        // Remove next stage button
        const confirmSettings = document.getElementById("confirm-settings");
        confirmSettings.remove();
        // Add submit button
        const buttonHolder = document.getElementById("button-holder");
        const submit = document.createElement("button");
        submit.style = "width: 200px;";
        submit.className = "function";
        submit.innerHTML = "Confirm Settings";
        if(this.stage != this.currentStage){
          submit.innerHTML = "Continue";
        }
        submit.id = "confirm-settings";
        buttonHolder.appendChild(submit);
        submit.addEventListener("click", () => this.submitChoices());
        // If this was a previous stage that the player is looking at, show them the results of their choices
        if(this.stage != this.currentStage){
          this.submitChoices();
        }
      }
      // Creates the checkboxes that are used for selecting permissions
      checkbox(appIndex, permission, index) {
        var newDiv = `<div style="margin-bottom: 10px;">
          <label>
            <input type="checkbox" data-app="${appIndex}" data-permission="${permission}"`;
        //If this was a previous stage, add whether the user checked the box or not
        if(this.stage in this.responses){
          if(this.responses[this.stage][appIndex][index]) {
            newDiv += ` checked`; 
          }
        }
        newDiv += ` />
            Allow ${appIndex.charAt(0).toUpperCase() + appIndex.slice(1)}
          </label>
        </div>`;
        return newDiv;
      }
      // Gets the users choices and compares them to the correct answers and displays the ones they got right/wrong along with an explanation for that app
      submitChoices() {
        // Get the player's answers
        const checkboxes = document.querySelectorAll("input[type=checkbox]");
        const userChoices = {};
        checkboxes.forEach(cb => {
          const appIndex = cb.dataset.app;
          const perm = cb.dataset.permission;
          cb.disabled = true;
          if (!userChoices[appIndex]) userChoices[appIndex] = [];
          userChoices[appIndex].push(cb.checked);
        });
        this.responses[this.stage] = userChoices;
        // See what the player got correct and incorrect and create the divs to show those results
        let score = 0;
        let total = this.selectedApps.length * 5;
        let feedback = "<h2 style='margin-top: 0'>Results:</h2>";
        this.selectedApps.forEach((app, i) => {
          feedback += `<li><strong>${app.name}</strong>:`;
          Object.entries(app.correctPermissions).forEach(([perm, correct]) => {
            const userValue = userChoices[perm]?.[i] || false; //This is an if statement
            if (userValue === correct) {
              score++;
              feedback += ` <span style="color: green">✓ ${perm}</span>`;
            } else {
              feedback += ` <span style="color: red">✗ ${perm}</span>`;
            }
          });
          feedback += `</ul><p>${app.explanation}</p></li>`;
        });
        feedback += `</ul><p>Your Score: ${score}/${total}</p>
        <p>It is important to make sure that you know what information you are giving to your apps. Limit what you want to share to certain apps to better protect your data.</p>`;
        // Add results to screen
        const resultsContainer = document.getElementById("results");
        const results = document.createElement("div");
        results.className = "app-container";
        results.innerHTML = feedback;
        resultsContainer.appendChild(results);
        // Get the player's score and save it to the session storage if this is not the tutorial
        if(this.stage != -1){
          var currentScore = JSON.parse(sessionStorage.getItem("currentScore")) + score;
          sessionStorage.setItem("currentScore", JSON.stringify(currentScore));
        }
        // Remove submit button
        const confirmSettings = document.getElementById("confirm-settings");
        confirmSettings.remove();
        // Add next stage button
        const buttonHolder = document.getElementById("button-holder");
        const nextStage = document.createElement("button");
        nextStage.style = "width: 200px;";
        nextStage.className = "function";
        nextStage.innerHTML = "Next Stage";
        nextStage.id = "confirm-settings";
        buttonHolder.appendChild(nextStage);
        nextStage.addEventListener("click", () => this.nextStage());
      }
      // Get stage from session storage and then use that number to advance to the next stage
      nextStage(){
        if(this.stage >= 11){ // If this was the final stage, take the player back to the menu
          sessionStorage.setItem("permissionsLevelStage",JSON.stringify(0));
          alert("You completed the app permissions level! Returning to the menu.");
          window.location.href = "../menu.html";
        }else{ // If it wasn't, clear the screen and add the next set of apps
          //If this wasn't a previous stage, update the current stage
          if(this.stage == this.currentStage){
            this.currentStage += 1;
            sessionStorage.setItem("permissionsLevelStage",JSON.stringify(this.currentStage));
            sessionStorage.setItem("permissionsLevelResponses",JSON.stringify(this.responses));
          }
          this.stage += 1;
          this.clearScreen();
          this.setQuestions();
          document.getElementById('body').scrollIntoView();
        }
      }
      //Clear the screen of all questions and answers
      clearScreen(){
        document.getElementById("apps").innerHTML = "";
        document.getElementById("title").innerHTML = "";
        document.getElementById("results").innerHTML = "";
      }
      //Set up the questions for the stage
      setQuestions(){
        this.selectedApps = []; //Array to store all of the selected questions
        //If this isn't the tutorial, set up five questions
        if(this.stage > 0){
          //Pick the questions based on the stage
          var end = this.stage*5;
          var start = end-4;
          //Select the questions
          for(var i = start; i <= end; i++){
            this.selectedApps.push(this.allApps[i]);
          }
        }else{ //If this is the tutorial, only set up the first question
          this.selectedApps.push(this.allApps[0]);
        }
        //Set up the questions on the UI
        this.createAppUI();
      }
      //Get all questions from the server
      async getAllQuestions(){
        var startTime = Date.now(); //Keep track of start and end time to calculate RTT
        //Send fetch request to the server
        var query = await fetch("/getAllPermissions",{
          method:"GET",
          headers:{
            "Content-Type":"application/json"
          },
        });
        //Get reply
        var result = await query.json();
        var endTime = Date.now();
        var rtt = startTime - endTime;
        console.log("/getPermissions Request RTTs:\nServer-Database Request RTT: "+result.rtt+"ms\nClient-Server Request RTT: "+rtt+"ms\n");
        //Store all questions
        this.allApps = result.questions;
        //Set up the first set of questions
        this.setQuestions();
        //If they are at the start of the level, do the tutorial
        if(this.stage == 0){
          this.doTutorial();
        }
      }
      //Go to the previous stage
      previousStage(){
        //Don't go to the stage before the beginning, because it does not exist
        if(this.stage <= 0){
          return;
        }
        //Go to the previous stage, clear the screen, and set it up with the previous stage's data
        this.stage -= 1;
        this.clearScreen();
        this.setQuestions();
        document.getElementById('body').scrollIntoView();
      }
    }
  </script>
</head>
<body id="body">
  <div class="menu" style="height: auto">
    <div id="title"></div>
  </div><br>
  <div id="apps-menu" class="menu" style="height: auto">
    <div id="apps"></div>
    <div id="results"></div>
    <div id="button-holder">
      <button id="confirm-settings" class="function" style="width: 200px" onclick="mymain.submitChoices()">Confirm Settings</button><br>
    </div>
    <button class="function" onclick="mymain.previousStage()" style="width: 200px">Previous Stage</button><br>
    <button class="function" onclick="window.location.href='../menu.html'" style="margin-bottom: 10px; width: 200px">Save and Quit</button>
  </div>

  <script>
    var mymain = new main;
  </script>
</body>
</html>