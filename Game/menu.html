<!DOCTYPE html>
<html lang="en">
    <!--for bootstrap-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <head>
        <script>
            //Start the smishing level either at the start or where the user last left off
            function startSmishingLevel(){
                var level1Stage = JSON.parse(sessionStorage.getItem("level1Stage"));
                if(level1Stage == 0 || level1Stage == null){ //If this is the user's first time playing the level, go to the beginning
                    window.location.href = "SmishingLevel/menu.html";
                }else{ //If it is not, go back to where they left off
                    window.location.href = "SmishingLevel/stages.html";
                }
            }
            //If the player was logged in, add their score to their account and return home
            async function returnHome(){
                //Check to see if the user's score was 0. If it was, don't do anything, as it probably means they didn't play the game
                var currentScore = JSON.parse(sessionStorage.getItem("currentScore"));
                if(currentScore <= 0){
                    window.location.href = "../Client/home.html";
                }
                //Check to see if the user was logged in
                var loggedIn = JSON.parse(sessionStorage.getItem("loggedIn"));
                if(!loggedIn){ //If they weren't, tell them that they should if they wish to save their score
                    alert("Tip: If you wish to save your current score, you should login or create an account.");
                    window.location.href = "../Client/home.html";
                    return;
                }
                //If they were, save their score to their account
                //Get their highest score
                var highScore = JSON.parse(sessionStorage.getItem("highScore"));
                //If they got a new high score, update it on their account
                var data = {}; //Create document containing data to be updated
                if(currentScore > highScore){
                    data = { //Update the document
                        user_id: JSON.parse(sessionStorage.getItem("userId")),
                        username: JSON.parse(sessionStorage.getItem("userData"))[0],
                        email: JSON.parse(sessionStorage.getItem("userData"))[1],
                        password: JSON.parse(sessionStorage.getItem("userData"))[2],
                        highScore: currentScore,
                        scores: JSON.parse(sessionStorage.getItem("scores"))
                    };
                    try{
                        //Send a query along a post request to the backend
                        var query = await fetch("/update",{
                            method: "POST",
                            headers:{
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(data)
                        });
                        //Get result and update session data
                        var result = await query.json();
                        sessionStorage.setItem("highScore",JSON.stringify(result.highScore));
                    }catch(Error){
                        alert(Error+" Please try again.");
                    }
                }
                //Try to add their current score onto their account(not as a highscore, in the array storing all their scores)
                //First add their current score into the their scores
                var scoreList = JSON.parse(sessionStorage.getItem("scores"));
                scoreList.push(currentScore);
                data = {
                    user_id: JSON.parse(sessionStorage.getItem("userId")),
                    username: JSON.parse(sessionStorage.getItem("userData"))[0],
                    email: JSON.parse(sessionStorage.getItem("userData"))[1],
                    password: JSON.parse(sessionStorage.getItem("userData"))[2],
                    highScore: JSON.parse(sessionStorage.getItem("highScore")),
                    scores: scoreList
                }
                try{
                    //Send a query along a post request to the backend
                    var query = await fetch("/update",{
                        method: "POST",
                        headers:{
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    });
                    //Get result and update session data
                    var result = await query.json(); 
                    sessionStorage.setItem("scores",JSON.stringify(result.scores));
                    //Say a different message if the player beat their high score or not
                    if(currentScore > highScore){
                        alert("Woah! A new high score! It was saved sucessfully to your account!")
                    }else{
                        alert("Your current score was save sucessfully to your account!");
                    }
                    window.location.href = '../Client/home.html';
                }catch(Error){
                    alert(Error+" Please try again.");
                }
            }
            //Add the current score to the screen
            function addCurrentScore(){
                var currentScore = JSON.parse(sessionStorage.getItem("currentScore"));
                var score = document.getElementById("currentScore");
                score.innerText = "Current Score: "+currentScore;
            }
        </script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="../styles.css">
    </head>
    <body>
		<div class="menu w-75 h-50" style="height: 420px;">
            <h1 style="font-family: 'Times New Roman', Times, serif; font-weight: bold;">Level Select</h1>
            <h4 style="font-family: 'Times New Roman', Times, serif; font-weight: bold; font-size: 1.1rem;" id="currentScore"></h4>
            <button class="selection" onclick="window.location.href = 'VishingLevel/VishingTut.html'" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Vishing Level</button>

            <button class="selection" onclick="window.location.href = 'PermissionsLevel/PermissionsLevel.html'" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">App Permissions Level</button><br>
            <button class="selection" onclick="startSmishingLevel()" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Smishing Level</button>

			<button class="selection" onclick="window.location.href = 'BadPacketsLevel/BadPacketsLevel.html'" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Bad Packets Level</button><br>
            <button class="selection" onclick="window.location.href = 'SpamEmailLevel/SpamEmailMenu.html'" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Phishing Level</button>
                        
            <button class="selection" onclick="window.location.href = 'JuiceJLevel.html'" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Juice Jacking Level</button><br>
            
            <button class="selection" onclick="window.location.href = 'CommonAttackLevel/CommonAttackTut.html'" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Common Attack Level</button><br>
            
            <center>
                <button class="selection" onclick="returnHome()" style="width: 180px; height:50px;font-family: 'Tahoma';font-weight: normal;font-size: 0.9rem;">Return Home</button>
            </center>
        </div>
        <script>addCurrentScore()</script>
    </body>
</html>
